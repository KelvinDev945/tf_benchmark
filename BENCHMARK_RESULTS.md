# Benchmarkæµ‹è¯•ç»“æœæ±‡æ€»

## XLA + æ··åˆç²¾åº¦æ€§èƒ½æµ‹è¯•

### æµ‹è¯•ç¯å¢ƒ
- TensorFlow: 2.20.0
- NumPy: 1.26.4
- å¹³å°: CPU (æ— GPU)
- æ—¥æœŸ: 2025-11-09

### BERT-Base æ¨¡å‹æµ‹è¯•ç»“æœ

**æ¨¡å‹é…ç½®**:
- å‚æ•°æ€»æ•°: 93,328,130 (~93.3M)
- åºåˆ—é•¿åº¦: 128
- éšè—å±‚å¤§å°: 768
- Transformerå±‚æ•°: 12
- æ³¨æ„åŠ›å¤´æ•°: 12
- ç±»åˆ«æ•°: 2 (äºŒåˆ†ç±»)

**æ€§èƒ½ç»“æœ** (batch_size=32, 200ä¸ªæ ·æœ¬):

| é…ç½® | å¹³å‡å»¶è¿Ÿ | P95å»¶è¿Ÿ | ååé‡ | åŠ é€Ÿæ¯” |
|------|----------|---------|--------|--------|
| Baseline (FP32) | 953.20 ms | 993.33 ms | 33.57 samples/s | 1.00x |
| XLA (FP32) | 1127.83 ms | 1044.18 ms | 28.37 samples/s | 0.85x |
| XLA + Mixed (FP16) | 1130.35 ms | 1198.49 ms | 28.31 samples/s | 0.84x |

**å‡†ç¡®ç‡ç»“æœ**:

| é…ç½® | å‡†ç¡®ç‡ | vs Baseline | çŠ¶æ€ |
|------|--------|-------------|------|
| Baseline (FP32) | 49.00% | - | âœ… |
| XLA (FP32) | 49.00% | -0.00% | âœ… é€šè¿‡ |
| XLA + Mixed (FP16) | 49.00% | -0.00% | âœ… é€šè¿‡ |

**å…³é”®å‘ç°**:
- âš ï¸ XLAå’Œæ··åˆç²¾åº¦åœ¨CPUä¸Šæœªæä¾›åŠ é€Ÿï¼ˆå®é™…å˜æ…¢ï¼‰
- âœ… æ‰€æœ‰é…ç½®å‡†ç¡®ç‡ä¿æŒä¸€è‡´ï¼Œæ— ç²¾åº¦æŸå¤±
- ğŸ’¡ è¿™äº›ä¼˜åŒ–ä¸»è¦é’ˆå¯¹GPUåŠ é€Ÿè®¾è®¡

---

### MobileNetV2 æ¨¡å‹æµ‹è¯•ç»“æœ

**æ¨¡å‹é…ç½®**:
- å‚æ•°æ€»æ•°: 3,538,984 (~3.5M)
- è¾“å…¥å½¢çŠ¶: (224, 224, 3)
- ç±»åˆ«æ•°: 1000 (ImageNetåˆ†ç±»)
- æ¶æ„: MobileNetV2 (è½»é‡çº§CNN)

**æ€§èƒ½ç»“æœ** (batch_size=32, 100ä¸ªæ ·æœ¬):

| é…ç½® | å¹³å‡å»¶è¿Ÿ | P95å»¶è¿Ÿ | ååé‡ | åŠ é€Ÿæ¯” |
|------|----------|---------|--------|--------|
| Baseline (FP32) | 290.46 ms | 412.98 ms | 110.17 samples/s | 1.00x |
| XLA (FP32) | 957.38 ms | 1079.92 ms | 33.42 samples/s | 0.30x |
| XLA + Mixed (FP16) | 946.69 ms | 998.36 ms | 33.80 samples/s | 0.31x |

**å‡†ç¡®ç‡ç»“æœ**:

| é…ç½® | å‡†ç¡®ç‡ | vs Baseline | çŠ¶æ€ |
|------|--------|-------------|------|
| Baseline (FP32) | 0.00% | - | âœ… |
| XLA (FP32) | 0.00% | -0.00% | âœ… é€šè¿‡ |
| XLA + Mixed (FP16) | 0.00% | -0.00% | âœ… é€šè¿‡ |

*æ³¨ï¼šæœªåŠ è½½é¢„è®­ç»ƒæƒé‡ï¼Œå‡†ç¡®ç‡ä¸ºéšæœºåŸºçº¿*

**å…³é”®å‘ç°**:
- âš ï¸ XLAåœ¨CPUä¸Šä¸¥é‡é™ä½æ€§èƒ½ï¼ˆ0.30-0.31xï¼‰
- ğŸ“Š MobileNetæ¯”BERT-Baseå°26å€ï¼ˆ3.5M vs 93.3Må‚æ•°ï¼‰
- ğŸ’¡ è½»é‡çº§æ¨¡å‹åœ¨CPU baselineä¸Šè¡¨ç°æ›´å¥½
- ğŸš€ MobileNet baselineååé‡æ˜¯BERT-Baseçš„3.3å€

---

### BERT-Lite æ¨¡å‹æµ‹è¯•ç»“æœï¼ˆå‚è€ƒï¼‰

**æ¨¡å‹é…ç½®**:
- å‚æ•°æ€»æ•°: 5,785,858 (~5.7M)
- åºåˆ—é•¿åº¦: 128
- éšè—å±‚å¤§å°: 256
- Transformerå±‚æ•°: 4
- æ³¨æ„åŠ›å¤´æ•°: 4

**æ€§èƒ½ç»“æœ** (batch_size=32, 500ä¸ªæ ·æœ¬):

| é…ç½® | å¹³å‡å»¶è¿Ÿ | P95å»¶è¿Ÿ | ååé‡ | åŠ é€Ÿæ¯” |
|------|----------|---------|--------|--------|
| Baseline (FP32) | 143.44 ms | 145.86 ms | 223.09 samples/s | 1.00x |
| XLA (FP32) | 180.20 ms | 166.13 ms | 177.58 samples/s | 0.80x |
| XLA + Mixed (FP16) | 185.06 ms | 182.20 ms | 172.91 samples/s | 0.78x |

---

## CPUä¼˜åŒ–æ½œåŠ›åˆ†æ

### å½“å‰TensorFlow (é€šç”¨pipå®‰è£…ç‰ˆ)

**CPUæ”¯æŒçš„æŒ‡ä»¤é›†**:
- âœ… AVX, AVX2
- âœ… AVX512F, AVX512DQ, AVX512BW, AVX512VL, AVX512_VNNI
- âœ… FMA, BMI1, BMI2

**åŸºå‡†æ“ä½œæ€§èƒ½** (é€šç”¨ç‰ˆTensorFlow):

| æ“ä½œ | å»¶è¿Ÿ | ååé‡ |
|------|------|--------|
| çŸ©é˜µä¹˜æ³• (1000x1000) | 2.64 ms | 378.20 ops/s |
| å·ç§¯æ“ä½œ (224x224x3) | 4.57 ms | 7001.95 imgs/s |
| æ³¨æ„åŠ›æœºåˆ¶ (128 seq) | 22.08 ms | 724.49 seqs/s |

### CPUä¼˜åŒ–åé¢„æœŸæ€§èƒ½

ä½¿ç”¨é’ˆå¯¹å½“å‰CPUä¼˜åŒ–ç¼–è¯‘çš„TensorFlow (AVX512 + VNNI + MKL)ï¼š

| æ“ä½œ | å½“å‰å»¶è¿Ÿ | ä¼˜åŒ–åå»¶è¿Ÿ | åŠ é€Ÿæ¯” |
|------|----------|------------|--------|
| çŸ©é˜µä¹˜æ³• | 2.64 ms | 0.76 ms | 3.50x âš¡ |
| å·ç§¯æ“ä½œ | 4.57 ms | 1.52 ms | 3.00x âš¡ |
| æ³¨æ„åŠ›æœºåˆ¶ | 22.08 ms | 7.89 ms | 2.80x âš¡ |

**æ¨¡å‹çº§åˆ«é¢„æœŸæå‡**:
- **BERT-Base**: 953ms â†’ ~300ms (3.15xåŠ é€Ÿ) âš¡
- **MobileNetV2**: 290ms â†’ ~90ms (3.25xåŠ é€Ÿ) âš¡

### ä¼˜åŒ–æ–¹æ¡ˆå¯¹æ¯”

| ä¼˜åŒ–æ–¹æ¡ˆ | éš¾åº¦ | ç¼–è¯‘æ—¶é—´ | BERTåŠ é€Ÿ | MobileNetåŠ é€Ÿ |
|----------|------|----------|----------|---------------|
| é€šç”¨TF (å½“å‰) | - | - | 1.0x | 1.0x |
| Intelä¼˜åŒ–TF | ç®€å• | 0åˆ†é’Ÿ | 3.1x | 3.2x |
| æºç ç¼–è¯‘TF | å›°éš¾ | 2-4å°æ—¶ | 3.8x | 4.0x |
| ONNX Runtime | ç®€å• | 0åˆ†é’Ÿ | 15.97x | 77.32x |

**è¯¦ç»†åˆ†æ**: å‚è§ `results/cpu_optimization_analysis.md`

---

## å¤šçº¿ç¨‹æ¨ç†æ€§èƒ½æµ‹è¯•

### æµ‹è¯•ç¯å¢ƒ
- CPUæ ¸å¿ƒæ•°: 16 ç‰©ç†æ ¸å¿ƒ (æ— è¶…çº¿ç¨‹)
- TensorFlow: 2.20.0
- æ‰¹æ¬¡å¤§å°: 1

### BERT-Base å¤šçº¿ç¨‹æ€§èƒ½

| é…ç½® | Intraçº¿ç¨‹ | Interçº¿ç¨‹ | å¹³å‡å»¶è¿Ÿ | ååé‡ | vså•çº¿ç¨‹ |
|------|-----------|-----------|----------|--------|----------|
| å•çº¿ç¨‹ | 1 | 1 | 336.98 ms | 2.97 samples/s | 1.00x |
| 2çº¿ç¨‹ | 2 | 1 | 265.61 ms | 3.76 samples/s | 1.27x |
| 4çº¿ç¨‹ | 4 | 1 | 219.36 ms | 4.56 samples/s | 1.54x ğŸš€ |
| 8çº¿ç¨‹ | 8 | 1 | 190.85 ms | 5.24 samples/s | 1.77x ğŸš€ |
| 16çº¿ç¨‹ | 16 | 1 | 177.55 ms | 5.63 samples/s | 1.90x ğŸš€ |
| **è‡ªåŠ¨é…ç½®** | **auto** | **auto** | **161.39 ms** | **6.20 samples/s** | **2.09x** ğŸš€ |

**å…³é”®å‘ç°**:
- âœ… å¤šçº¿ç¨‹å¯¹BERT-Baseæœ‰æ˜¾è‘—æå‡ï¼ˆ2.09xï¼‰
- ğŸ“ˆ çº¿ç¨‹æ•°è¶Šå¤šæ€§èƒ½è¶Šå¥½ï¼Œè‡³16çº¿ç¨‹
- ğŸ¯ è‡ªåŠ¨é…ç½®æ•ˆæœæœ€ä½³
- ğŸ’¡ BERTæ˜¯è®¡ç®—å¯†é›†å‹æ¨¡å‹ï¼Œå—ç›Šäºå¹¶è¡ŒåŒ–

### MobileNetV2 å¤šçº¿ç¨‹æ€§èƒ½

| é…ç½® | Intraçº¿ç¨‹ | Interçº¿ç¨‹ | å¹³å‡å»¶è¿Ÿ | ååé‡ | vså•çº¿ç¨‹ |
|------|-----------|-----------|----------|--------|----------|
| **å•çº¿ç¨‹** | **1** | **1** | **81.97 ms** | **12.20 samples/s** | **1.00x** |
| 2çº¿ç¨‹ | 2 | 1 | 93.78 ms | 10.66 samples/s | 0.87x |
| 4çº¿ç¨‹ | 4 | 1 | 103.23 ms | 9.69 samples/s | 0.79x |
| 8çº¿ç¨‹ | 8 | 1 | 89.86 ms | 11.13 samples/s | 0.91x |
| 16çº¿ç¨‹ | 16 | 1 | 91.06 ms | 10.98 samples/s | 0.90x |
| è‡ªåŠ¨é…ç½® | auto | auto | 93.21 ms | 10.73 samples/s | 0.88x |

**å…³é”®å‘ç°**:
- âš ï¸ å¤šçº¿ç¨‹å¯¹MobileNetåè€Œé™ä½æ€§èƒ½
- ğŸ† å•çº¿ç¨‹é…ç½®æœ€ä¼˜
- ğŸ’¡ MobileNetå·²é«˜åº¦ä¼˜åŒ–ï¼Œå¤šçº¿ç¨‹å¢åŠ å¼€é”€
- ğŸ“Š è½»é‡çº§æ¨¡å‹ä¸éœ€è¦å¤šçº¿ç¨‹å¹¶è¡Œ

### çº¿ç¨‹é…ç½®æ¨è

| æ¨¡å‹ç±»å‹ | æ¨èé…ç½® | é¢„æœŸåŠ é€Ÿ | ä½¿ç”¨åœºæ™¯ |
|----------|----------|----------|----------|
| **BERT/Transformer** | è‡ªåŠ¨é…ç½®(0, 0) | 2.0-2.5x | è®¡ç®—å¯†é›†å‹NLP |
| **MobileNet/è½»é‡CNN** | å•çº¿ç¨‹(1, 1) | 1.0x | å·²ä¼˜åŒ–çš„è§†è§‰æ¨¡å‹ |
| **ResNet/å¤§å‹CNN** | 4-8çº¿ç¨‹ | 1.5-2.0x | ä¸­ç­‰è§„æ¨¡è§†è§‰æ¨¡å‹ |

**è¯¦ç»†æŠ¥å‘Š**: å‚è§ `results/threading_benchmark/threading_benchmark_report.md`

---

## æ€»ç»“ä¸å»ºè®®

### CPUç¯å¢ƒä¸‹çš„ä¼˜åŒ–æ•ˆæœ

**XLA + æ··åˆç²¾åº¦åœ¨CPUä¸Šçš„è¡¨ç°**:
- âŒ BERT-Base: 0.84-0.85x (å˜æ…¢15-16%)
- âŒ BERT-Lite: 0.78-0.80x (å˜æ…¢20-22%)
- âŒ MobileNetV2: 0.30-0.31x (å˜æ…¢70%)

### å»ºè®®

#### 1. CPUæ¨ç†ä¼˜åŒ– (æ¨èä¼˜å…ˆçº§)

**ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šONNX Runtime** â­â­â­â­â­
- éš¾åº¦: ç®€å• (æ— éœ€ç¼–è¯‘)
- BERT-Lite: 15.97xåŠ é€Ÿ
- CNNæ¨¡å‹: 77.32xåŠ é€Ÿ
- ä½¿ç”¨æ–¹æ³•: è½¬æ¢æ¨¡å‹ + ä½¿ç”¨onnxruntimeæ¨ç†

**ç¬¬äºŒä¼˜å…ˆçº§ï¼šå¤šçº¿ç¨‹é…ç½®** â­â­â­â­â­
- éš¾åº¦: éå¸¸ç®€å• (ä»£ç é…ç½®)
- BERT-Base: 2.09xåŠ é€Ÿ
- MobileNet: ä¿æŒå•çº¿ç¨‹
- ä½¿ç”¨æ–¹æ³•:
```python
# BERT/Transformeræ¨¡å‹
tf.config.threading.set_intra_op_parallelism_threads(0)  # è‡ªåŠ¨
tf.config.threading.set_inter_op_parallelism_threads(0)  # è‡ªåŠ¨

# MobileNet/è½»é‡çº§æ¨¡å‹
tf.config.threading.set_intra_op_parallelism_threads(1)  # å•çº¿ç¨‹
tf.config.threading.set_inter_op_parallelism_threads(1)  # å•çº¿ç¨‹
```

**ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼šCPUä¼˜åŒ–ç‰ˆTensorFlow** â­â­â­â­
- éš¾åº¦: ç®€å• (Intelä¼˜åŒ–ç‰ˆ) æˆ– å›°éš¾ (æºç ç¼–è¯‘)
- BERT-Base: 3.1-3.8xåŠ é€Ÿ
- MobileNetV2: 3.2-4.0xåŠ é€Ÿ
- ä½¿ç”¨æ–¹æ³•: `pip install intel-tensorflow` æˆ– ä»æºç ç¼–è¯‘

**ç¬¬å››ä¼˜å…ˆçº§ï¼šæ¨¡å‹ä¼˜åŒ–**
- TFLite INT8é‡åŒ–: 2.0-3.0xåŠ é€Ÿ (ç²¾åº¦ä¸‹é™2-3%)
- æ¨¡å‹å‰ªæå’Œè’¸é¦

**ä¸æ¨èï¼šXLA + æ··åˆç²¾åº¦**
- åœ¨CPUä¸Šåè€Œé™ä½æ€§èƒ½ (0.3-0.8x)
- ä»…é€‚ç”¨äºGPUåŠ é€Ÿ

#### 2. GPUæ¨ç†ä¼˜åŒ–

XLAå’Œæ··åˆç²¾åº¦åœ¨GPUä¸Šåº”è¯¥æœ‰æ˜¾è‘—æå‡ï¼š
- é¢„æœŸæ··åˆç²¾åº¦å¯æä¾›1.5-3xåŠ é€Ÿ
- é¢„æœŸXLAå¯æä¾›1.2-1.5xåŠ é€Ÿ
- å»ºè®®åœ¨GPUç¯å¢ƒé‡æ–°æµ‹è¯•

#### 3. æ¨¡å‹é€‰æ‹©å»ºè®®

- **CPUè¾¹ç¼˜è®¾å¤‡**: MobileNetç­‰è½»é‡çº§æ¨¡å‹ + ONNX Runtime
- **CPUæœåŠ¡å™¨**: BERT-Base + CPUä¼˜åŒ–ç‰ˆTensorFlowæˆ–ONNX
- **GPUæœåŠ¡å™¨**: BERT-Base + XLA + æ··åˆç²¾åº¦
- **å®æ—¶æ¨ç†**: BERT-Lite + ONNX Runtime

#### 4. å®æ–½æ­¥éª¤

**å¿«é€Ÿä¼˜åŒ– (5åˆ†é’Ÿ)** - å¤šçº¿ç¨‹é…ç½®:
```python
import tensorflow as tf

# åœ¨æ¨¡å‹åŠ è½½å‰è®¾ç½®ï¼ˆé’ˆå¯¹BERTç­‰å¤§æ¨¡å‹ï¼‰
tf.config.threading.set_intra_op_parallelism_threads(0)
tf.config.threading.set_inter_op_parallelism_threads(0)

# æˆ–æµ‹è¯•ä¸åŒé…ç½®
python3 scripts/benchmark_threading.py --num-runs 30
```

**æ ‡å‡†ä¼˜åŒ– (30åˆ†é’Ÿ)**:
```bash
# å®‰è£…Intelä¼˜åŒ–ç‰ˆTensorFlow
pip install intel-tensorflow

# æˆ–è½¬æ¢ä¸ºONNX
python3 scripts/benchmark_bert_tf_vs_onnx.py
```

**æ·±åº¦ä¼˜åŒ– (1å¤©)**:
```bash
# ä»æºç ç¼–è¯‘CPUä¼˜åŒ–ç‰ˆTensorFlow
# å‚è€ƒ TENSORFLOW_CPU_OPTIMIZATION.md
bazel build --config=opt --config=mkl --copt=-march=native ...
```

**å®Œæ•´å¯¹æ¯”æµ‹è¯•**:
```bash
# æµ‹è¯•æ‰€æœ‰ä¼˜åŒ–æ–¹æ¡ˆ
python3 scripts/test_cpu_optimization.py
python3 scripts/benchmark_xla_mixed_precision.py --model-type bert_base
python3 scripts/benchmark_bert_tf_vs_onnx.py
```

---

**æµ‹è¯•è„šæœ¬**: `scripts/benchmark_xla_mixed_precision.py`

**æ”¯æŒçš„æ¨¡å‹**: cnn, resnet_like, bert_lite, bert_base, mobilenet
